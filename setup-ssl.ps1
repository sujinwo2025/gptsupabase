# Bytrix API - Auto SSL Setup Script (Windows PowerShell)
# Usage: .\setup-ssl.ps1 -Domain file.bytrix.my.id -Email admin@example.com

param(
    [Parameter(Mandatory=$true)]
    [string]$Domain,
    
    [Parameter(Mandatory=$false)]
    [string]$Email = "admin@example.com"
)

$ErrorActionPreference = "Stop"

# Colors
$Green = "Green"
$Red = "Red"
$Yellow = "Yellow"
$Blue = "Cyan"

function Write-Title {
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor $Blue
    Write-Host "â•‘   Bytrix API - Auto SSL Setup (Let's Encrypt + Caddy)     â•‘" -ForegroundColor $Blue
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Blue
    Write-Host ""
}

function Write-Step($message) {
    Write-Host $message -ForegroundColor $Yellow
}

function Write-Success($message) {
    Write-Host "âœ“ $message" -ForegroundColor $Green
}

function Write-Error($message) {
    Write-Host "âœ— $message" -ForegroundColor $Red
}

Write-Title

Write-Host "ğŸ“‹ Configuration:" -ForegroundColor $Yellow
Write-Host "  Domain: $Domain" -ForegroundColor $Green
Write-Host "  Email:  $Email" -ForegroundColor $Green
Write-Host ""

# 1. Create SSL directories
Write-Step "ğŸ“ Creating SSL directories..."
@(
    "ssl\letsencrypt",
    "ssl\certbot",
    "caddy\data",
    "caddy\config",
    "logs\nginx"
) | ForEach-Object {
    if (-not (Test-Path $_)) {
        New-Item -ItemType Directory -Path $_ -Force | Out-Null
    }
}
Write-Success "Directories created"
Write-Host ""

# 2. Update .env file
Write-Step "ğŸ”§ Updating .env file..."
if (Test-Path ".env") {
    $envContent = Get-Content ".env"
    if ($envContent -match "^DOMAIN=") {
        $envContent = $envContent -replace "^DOMAIN=.*", "DOMAIN=https://$Domain"
    } else {
        $envContent += "`nDOMAIN=https://$Domain"
    }
    Set-Content -Path ".env" -Value $envContent
    Write-Success "Updated DOMAIN in .env"
} else {
    Write-Host "DOMAIN=https://$Domain" | Out-File -FilePath ".env" -Encoding UTF8
    Write-Success ".env created with DOMAIN"
}
Write-Host ""

# 3. Update nginx.conf
Write-Step "ğŸ”— Updating Nginx configuration..."
if (Test-Path "nginx.conf") {
    $nginxContent = Get-Content "nginx.conf" -Raw
    $nginxContent = $nginxContent -replace "DOMAIN_PLACEHOLDER", $Domain
    Set-Content -Path "nginx.conf" -Value $nginxContent
    Write-Success "Updated Nginx config"
} else {
    Write-Error "nginx.conf not found"
}
Write-Host ""

# 4. Create temp self-signed cert
Write-Step "ğŸ” Creating temporary self-signed certificate..."
$certPath = "ssl\letsencrypt\live\$Domain"
if (-not (Test-Path $certPath)) {
    New-Item -ItemType Directory -Path $certPath -Force | Out-Null
}

# Using OpenSSL (if available)
$opensslPath = Get-Command openssl -ErrorAction SilentlyContinue
if ($opensslPath) {
    & openssl req -x509 -nodes -days 365 -newkey rsa:2048 `
        -keyout "$certPath\privkey.pem" `
        -out "$certPath\fullchain.pem" `
        -subj "/CN=$Domain" 2>$null
    Write-Success "Self-signed certificate created"
} else {
    Write-Host "âš ï¸  OpenSSL not found. Please install it or use online tools." -ForegroundColor Yellow
}
Write-Host ""

# 5. Create docker-compose .env file
Write-Step "ğŸ“ Creating docker-compose .env file..."
$dockerEnv = @"
# Generated by setup-ssl.ps1
DOMAIN=https://$Domain
EMAIL=$Email
"@
$dockerEnv | Out-File -FilePath ".env.docker" -Encoding UTF8
Write-Success "Docker environment file created"
Write-Host ""

# 6. Display instructions
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Blue
Write-Success "Setup complete!"
Write-Host ""

Write-Host "ğŸ“‹ Next Steps:" -ForegroundColor $Yellow
Write-Host ""
Write-Host "1ï¸âƒ£  Make sure ports 80 and 443 are open:" -ForegroundColor $Yellow
Write-Host "   $Domain should be pointing to your server IP (165.22.244.107)" -ForegroundColor $Blue
Write-Host ""

Write-Host "2ï¸âƒ£  Start containers with Docker Compose:" -ForegroundColor $Yellow
Write-Host "   docker-compose up -d" -ForegroundColor $Blue
Write-Host ""

Write-Host "3ï¸âƒ£  Generate Let's Encrypt certificate:" -ForegroundColor $Yellow
Write-Host "   docker-compose exec certbot certbot certonly --webroot -w /var/www/certbot -d $Domain --email $Email --agree-tos --non-interactive" -ForegroundColor $Blue
Write-Host ""

Write-Host "4ï¸âƒ£  Verify SSL certificate:" -ForegroundColor $Yellow
Write-Host "   docker-compose exec nginx openssl x509 -in /etc/letsencrypt/live/$Domain/fullchain.pem -text -noout" -ForegroundColor $Blue
Write-Host ""

Write-Host "5ï¸âƒ£  Check status:" -ForegroundColor $Yellow
Write-Host "   curl -k https://$Domain/health" -ForegroundColor $Blue
Write-Host ""

Write-Host "ğŸ”„ SSL Auto-Renewal:" -ForegroundColor $Yellow
Write-Host "   Certbot will automatically renew certificates 30 days before expiry." -ForegroundColor $Blue
Write-Host ""

Write-Host "ğŸ”§ Configuration Files:" -ForegroundColor $Yellow
Write-Host "   â€¢ docker-compose.yml - Full stack configuration" -ForegroundColor $Blue
Write-Host "   â€¢ nginx.conf - Nginx with SSL" -ForegroundColor $Blue
Write-Host "   â€¢ caddy/Caddyfile - Caddy backup config" -ForegroundColor $Blue
Write-Host "   â€¢ .env - Environment variables" -ForegroundColor $Blue
Write-Host "   â€¢ .env.docker - Docker-specific variables" -ForegroundColor $Blue
Write-Host ""

Write-Host "ğŸ“Š Monitoring Logs:" -ForegroundColor $Yellow
Write-Host "   â€¢ docker-compose logs nginx" -ForegroundColor $Blue
Write-Host "   â€¢ docker-compose logs certbot" -ForegroundColor $Blue
Write-Host "   â€¢ docker-compose logs bytrix-api" -ForegroundColor $Blue
Write-Host "   â€¢ docker-compose logs caddy" -ForegroundColor $Blue
Write-Host ""

Write-Host "ğŸ› ï¸  Troubleshooting:" -ForegroundColor $Yellow
Write-Host "   â€¢ Check domain DNS: nslookup $Domain" -ForegroundColor $Blue
Write-Host "   â€¢ Check ports: netstat -ano | findstr :80" -ForegroundColor $Blue
Write-Host "   â€¢ Restart containers: docker-compose restart" -ForegroundColor $Blue
Write-Host "   â€¢ View logs: docker-compose logs -f" -ForegroundColor $Blue
Write-Host ""

Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Blue
Write-Host ""
